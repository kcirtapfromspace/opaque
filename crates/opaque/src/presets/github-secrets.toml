# Opaque preset: github-secrets
#
# Allows Claude Code and Codex to sync GitHub secrets (Actions, Codespaces,
# Dependabot, and organization secrets). Read operations (list/delete) use
# first-use approval with a 5-minute lease. Write operations (set) require
# biometric approval every time.
#
# Risk: Low. Secret *values* are never returned to agents. Agents can set
# or delete secret entries, but the plaintext values are resolved inside
# opaqued and sent directly to the GitHub API.
#
# Usage:
#   opaque policy preset apply github-secrets

# ---- Known human clients ----
# Customize these to match your local setup.

[[known_human_clients]]
name = "opaque-cli"
exe_path = "*/opaque"

# ---- GitHub secret write rules ----

[[rules]]
name = "allow-github-actions-secret"
operation_pattern = "github.set_actions_secret"
allow = true
client_types = ["agent", "human"]

[rules.approval]
require = "always"
factors = ["local_bio"]
lease_ttl = 300

[[rules]]
name = "allow-github-codespaces-secret"
operation_pattern = "github.set_codespaces_secret"
allow = true
client_types = ["agent", "human"]

[rules.approval]
require = "always"
factors = ["local_bio"]
lease_ttl = 300

[[rules]]
name = "allow-github-dependabot-secret"
operation_pattern = "github.set_dependabot_secret"
allow = true
client_types = ["agent", "human"]

[rules.approval]
require = "always"
factors = ["local_bio"]
lease_ttl = 300

[[rules]]
name = "allow-github-org-secret"
operation_pattern = "github.set_org_secret"
allow = true
client_types = ["agent", "human"]

[rules.approval]
require = "always"
factors = ["local_bio"]
lease_ttl = 300

# ---- GitHub read/delete rules (lower risk) ----

[[rules]]
name = "allow-github-list-secrets"
operation_pattern = "github.list_secrets"
allow = true
client_types = ["agent", "human"]

[rules.approval]
require = "first_use"
factors = ["local_bio"]
lease_ttl = 300

[[rules]]
name = "allow-github-delete-secret"
operation_pattern = "github.delete_secret"
allow = true
client_types = ["agent", "human"]

[rules.approval]
require = "always"
factors = ["local_bio"]
lease_ttl = 300

# ---- Test operation (for onboarding) ----

[[rules]]
name = "allow-test-noop"
operation_pattern = "test.noop"
allow = true
client_types = ["agent", "human"]

[rules.approval]
require = "first_use"
factors = ["local_bio"]
lease_ttl = 300
